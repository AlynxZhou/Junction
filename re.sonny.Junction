#!/usr/bin/env -S gjs -m

// -*- mode: js; -*-

globalThis.__DEV__ = true;

import { programInvocationName } from "system";
import GLib from "gi://GLib";

const byteArray = imports.byteArray;

const [filename] = GLib.filename_from_uri(import.meta.url);
const dirname = GLib.path_get_dirname(filename);

const [, , stderr, status] = GLib.spawn_command_line_sync(
  `glib-compile-schemas --strict ${GLib.canonicalize_filename(
    "./data",
    dirname,
  )}`,
);
if (status !== 0) {
  throw new Error(byteArray.toString(stderr));
}

GLib.setenv(
  "GSETTINGS_SCHEMA_DIR",
  GLib.canonicalize_filename("./data", dirname),
  true,
);

const loop = GLib.MainLoop.new(null, false);
import("./src/main.js")
  .then(({ default: main }) => {
    loop.quit();
    main([programInvocationName, ...ARGV], {
      version: "dev",
    });
  })
  .catch(logError);

loop.run();

// You probably should not do this but
// if you want this development version of Junction to be the default handler
// cp data/re.sonny.Junction.desktop ~/.local/share/applications/ && update-desktop-database ~/.local/share/applications
// and edit ~/.local/share/applications/re.sonny.Junction.desktop Exec to be
// gjs -m path-to/Junction/re.sonny.Junction %u
